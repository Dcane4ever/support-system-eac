<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Queue - EAC Classroom</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .queue-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .queue-header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .queue-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: var(--eac-red);
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .queue-list {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .queue-empty {
            text-align: center;
            padding: 4rem 2rem;
            color: #999;
        }
        
        .queue-empty .material-icons {
            font-size: 80px;
            color: #ddd;
            margin-bottom: 1rem;
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        
        .queue-item:hover {
            background: #f9f9f9;
        }
        
        .queue-item:last-child {
            border-bottom: none;
        }
        
        .student-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--eac-red);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
        }
        
        .student-info {
            flex: 1;
            margin-left: 1.5rem;
        }
        
        .student-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .student-id {
            font-size: 14px;
            color: #666;
        }
        
        .wait-time {
            font-size: 14px;
            color: #999;
            margin-right: 2rem;
        }
        
        .btn-accept {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-accept:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .btn-accept:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <a href="/support/dashboard" class="back-btn">
                <span class="material-icons">arrow_back</span>
            </a>
            <h1>üìã Support Queue</h1>
        </div>
        <div class="nav-menu">
            <span class="status-indicator" id="agentStatusIndicator">‚óè Available</span>
            <span th:text="${user.fullName}">Agent</span>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="btn-logout">Logout</button>
            </form>
        </div>
    </div>
    
    <div class="queue-container">
        <div class="queue-header">
            <h2>Waiting Students</h2>
            <p style="color: #666; margin-top: 0.5rem;">Accept students from the queue to start a support session</p>
            
            <div class="queue-stats">
                <div class="stat-card">
                    <div class="stat-number" id="queueSizeDisplay">0</div>
                    <div class="stat-label">In Queue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeSessionsDisplay">0</div>
                    <div class="stat-label">Active Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgWaitTimeDisplay">< 2 min</div>
                    <div class="stat-label">Avg. Wait Time</div>
                </div>
            </div>
        </div>
        
        <div class="queue-list">
            <div id="queueEmpty" class="queue-empty">
                <span class="material-icons">inbox</span>
                <h3>No Students Waiting</h3>
                <p>The queue is empty. New support requests will appear here.</p>
            </div>
            
            <div id="queueItems">
                <!-- Queue items will be added here dynamically -->
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const currentAgent = {
            id: /*[[${user.id}]]*/ 0,
            name: /*[[${user.fullName}]]*/ 'Agent',
            username: /*[[${user.username}]]*/ 'agent'
        };

        let socket = null;
        let stompClient = null;
        let waitingStudents = [];
        let isConnecting = false;

        // Connect to WebSocket
        function connect() {
            if (isConnecting || (stompClient && stompClient.connected)) {
                console.log('Already connected or connecting');
                return;
            }
            
            isConnecting = true;
            console.log('Connecting to WebSocket...');
            
            socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected: ' + frame);
                isConnecting = false;
                
                // Subscribe to queue updates (broadcast to all agents)
                stompClient.subscribe('/topic/queue-updates', function(message) {
                    const data = JSON.parse(message.body);
                    console.log('Queue update received:', data);
                    handleQueueUpdate(data);
                });
                
                // Load current queue
                loadQueue();
                
            }, function(error) {
                console.error('WebSocket connection error:', error);
                isConnecting = false;
                setTimeout(connect, 5000);
            });
        }

        // Load initial queue
        function loadQueue() {
            fetch('/api/chat/queue')
                .then(response => response.json())
                .then(data => {
                    console.log('Queue loaded:', data);
                    waitingStudents = data.waitingStudents || [];
                    updateQueueDisplay();
                })
                .catch(error => {
                    console.error('Error loading queue:', error);
                });
        }

        // Handle queue updates
        function handleQueueUpdate(data) {
            switch(data.type) {
                case 'NEW_STUDENT':
                    // Add student to queue
                    const student = {
                        sessionId: data.sessionId,
                        studentName: data.studentName,
                        studentId: data.studentId,
                        startedAt: new Date().toISOString()
                    };
                    waitingStudents.push(student);
                    updateQueueDisplay();
                    showNotification('New student in queue: ' + data.studentName);
                    break;
                    
                case 'STUDENT_ASSIGNED':
                    // Remove student from queue
                    waitingStudents = waitingStudents.filter(s => s.sessionId !== data.sessionId);
                    updateQueueDisplay();
                    break;
                    
                case 'QUEUE_UPDATE':
                    // Refresh queue
                    loadQueue();
                    break;
            }
        }

        // Update queue display
        function updateQueueDisplay() {
            const queueEmpty = document.getElementById('queueEmpty');
            const queueItems = document.getElementById('queueItems');
            const queueSizeDisplay = document.getElementById('queueSizeDisplay');
            
            queueSizeDisplay.textContent = waitingStudents.length;
            
            if (waitingStudents.length === 0) {
                queueEmpty.style.display = 'block';
                queueItems.innerHTML = '';
            } else {
                queueEmpty.style.display = 'none';
                queueItems.innerHTML = waitingStudents.map((student, index) => `
                    <div class="queue-item">
                        <div class="student-avatar">${getInitial(student.studentName)}</div>
                        <div class="student-info">
                            <div class="student-name">${escapeHtml(student.studentName)}</div>
                            <div class="student-id">ID: ${escapeHtml(student.studentId || 'N/A')}</div>
                        </div>
                        <div class="wait-time">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">schedule</span>
                            Waiting ${getWaitTime(student.startedAt)}
                        </div>
                        <button class="btn-accept" onclick="acceptStudent(${student.sessionId})">
                            <span class="material-icons">check_circle</span>
                            Accept
                        </button>
                    </div>
                `).join('');
            }
        }

        // Accept student from queue
        function acceptStudent(sessionId) {
            console.log('Accepting student, session ID:', sessionId);
            
            if (stompClient && stompClient.connected) {
                stompClient.send('/app/chat/accept', {}, JSON.stringify({
                    agentUsername: currentAgent.username,
                    sessionId: sessionId
                }));
                
                // Redirect to chat page
                setTimeout(() => {
                    window.location.href = '/support/chat';
                }, 500);
            } else {
                alert('Connection lost. Reconnecting...');
                connect();
            }
        }

        // Show browser notification
        function showNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('EAC Classroom Support', {
                    body: message,
                    icon: '/logo/EAC.png'
                });
            }
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Get initial from name
        function getInitial(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }

        // Get wait time
        function getWaitTime(startedAt) {
            const start = new Date(startedAt);
            const now = new Date();
            const diff = Math.floor((now - start) / 1000); // seconds
            
            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm';
            return Math.floor(diff / 3600) + 'h ' + Math.floor((diff % 3600) / 60) + 'm';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Queue page initialized for agent:', currentAgent.name);
            requestNotificationPermission();
            connect();
            
            // Refresh queue every 30 seconds
            setInterval(loadQueue, 30000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (stompClient && stompClient.connected) {
                stompClient.disconnect();
            }
        });
    </script>
</body>
</html>
